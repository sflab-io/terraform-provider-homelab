# GitHub Actions workflow for automated releases using GoReleaser
#
# This workflow triggers when you push a version tag (e.g., v0.1.0, v1.2.3)
# and automatically builds cross-platform binaries, creates GitHub releases,
# and prepares artifacts for Terraform Registry publishing.
#
# Usage:
#   git tag v0.2.0
#   git push origin v0.2.0
#
# The workflow will automatically:
#   1. Build binaries for all supported platforms (Linux, macOS, Windows)
#   2. Create zip archives following Terraform naming conventions
#   3. Generate SHA256SUMS file for integrity verification
#   4. Create a GitHub release with all artifacts attached
#   5. Generate release notes from commits since last tag

name: Release

on:
  push:
    # Only trigger on version tags (v1.0.0, v0.1.0, etc.)
    tags:
      - 'v*.*.*'

permissions:
  # Required for creating GitHub releases and uploading assets
  contents: write
  # Required for creating attestations (optional, for supply chain security)
  id-token: write
  attestations: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch all history and tags for changelog generation
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          # Use Go version specified in go.mod (1.24.2)
          go-version: '1.24.2'

      - name: Run tests
        run: |
          # Run tests if they exist
          # This ensures we don't release broken code
          # Currently the provider has no automated tests, but this is ready for when they're added
          if [ -n "$(go list ./... | grep -v /vendor/)" ]; then
            go test -v ./...
          else
            echo "No tests found, skipping test step"
          fi

      # OPTIONAL: Import GPG key for signing releases
      # This is recommended for Terraform Registry publishing
      # To enable:
      # 1. Generate GPG key locally: gpg --full-generate-key
      # 2. Export private key: gpg --armor --export-secret-keys sflab-io@web.de
      # 3. Add to GitHub Secrets as GPG_PRIVATE_KEY
      # 4. Add GPG_FINGERPRINT to GitHub Secrets (gpg --list-secret-keys --keyid-format LONG)
      # 5. Uncomment the section below and the signs section in .goreleaser.yml
      #
      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          # Use latest stable version of GoReleaser
          version: latest
          # Run the release process
          args: release --clean
        env:
          # GitHub token for creating releases and uploading assets
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # OPTIONAL: GPG fingerprint for signing (uncomment when using GPG signing)
          GPG_FINGERPRINT: ${{ secrets.GPG_FINGERPRINT }}

      # OPTIONAL: Generate build provenance attestation
      # This provides supply chain security metadata about the build
      # Uncomment to enable (requires id-token and attestations permissions above)
      #
      # - name: Generate build provenance
      #   uses: actions/attest-build-provenance@v2
      #   with:
      #     subject-path: 'dist/*.zip'

# Expected artifacts after release:
# - terraform-provider-homelab_X.Y.Z_linux_amd64.zip
# - terraform-provider-homelab_X.Y.Z_linux_arm64.zip
# - terraform-provider-homelab_X.Y.Z_darwin_amd64.zip
# - terraform-provider-homelab_X.Y.Z_darwin_arm64.zip
# - terraform-provider-homelab_X.Y.Z_windows_amd64.zip
# - terraform-provider-homelab_X.Y.Z_SHA256SUMS
# - terraform-provider-homelab_X.Y.Z_SHA256SUMS.sig (if GPG signing enabled)
#
# Next steps for Terraform Registry publishing:
# 1. Enable GPG signing (see comments above)
# 2. Create account on registry.terraform.io
# 3. Link this GitHub repository
# 4. Add your GPG public key to your Terraform Registry account
# 5. Push a new version tag - the registry will auto-detect and publish
# 6. Documentation and examples should be in the docs/ directory (create if needed)
