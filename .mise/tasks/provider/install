#!/usr/bin/env bash

#MISE description "Install the Terraform HomeLab provider"

#USAGE arg "<version>" help="Version of the Terraform HomeLab provider to install" default="0.3.0"

set -euo pipefail

GITHUB_USER="sflab-io"
OS_ARCH="$(go env GOOS)_$(go env GOARCH)"

echo ""
echo "ðŸ“¦ Removing existing Terraform HomeLab provider from \$GOROOT/bin ($GOROOT/bin)..."
rm -f "$GOROOT/bin/terraform-provider-homelab"
rm -rf $HOME/.local/share/opentofu/plugins/

echo ""
echo "ðŸ“¦ Building Terraform HomeLab provider with GoReleaser (snapshot mode)..."

# Build using GoReleaser in snapshot mode for local development
# --snapshot: No git tag required, uses timestamp-based versioning
# --single-target: Builds only for current platform (faster)
# --clean: Removes dist/ before building
goreleaser build --snapshot --single-target --clean

echo ""
echo "ðŸ“¦ Installing Terraform HomeLab provider to \$GOROOT/bin ($GOROOT/bin)..."

# Extract the binary from dist/ and install to GOBIN
# GoReleaser build creates subdirectories for each target (e.g., dist/terraform-provider-homelab_darwin_arm64_v8.0/)
BINARY_PATH=$(find dist -name terraform-provider-homelab -type f | head -1)
cp "$BINARY_PATH" "$(go env GOBIN)/terraform-provider-homelab"

# To use the provider with OpenTofu, we need to copy the binary to the tofu plugins directory
# The directory is usually located at ~/.local/share/opentofu/plugins/registry.terraform.io/<namespace>/<name>/<version>/<os_arch>/
# This is required so the provider will be discovered by OpenTofu when running terragrunt / terraform commands
# To configure where the provider could be found create a ~/.tofurc file with the following content:
# provider_installation {
#   dev_overrides {
#     "registry.terraform.io/sflab-io/homelab" = "/Users/seba/.local/share/mise/installs/go/1.24.2/bin"
#   }
#
#   direct {}
# }

echo ""
echo "ðŸ“¦ Copying Terraform HomeLab provider to OpenTofu plugins directory..."
echo ""

# Create the directory structure
TARGET_DIR=$HOME/.local/share/opentofu/plugins/registry.terraform.io/$GITHUB_USER/homelab/${usage_version?}/$OS_ARCH
mkdir -p "$TARGET_DIR"

# Linking the provider binary from the Go bin directory(target of go install . from above) to the tofu plugins directory
ln -vs \
     "$(go env GOBIN)/terraform-provider-homelab" \
     "$TARGET_DIR/terraform-provider-homelab_v${usage_version?}"

echo ""
echo "âœ… Provider installation completed successfully!"
